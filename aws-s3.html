<script type="text/x-red" data-template-name="aws-s3-config">
    <div class="form-row">
        <label for="node-config-input-configname"><i class="fa fa-bookmark"></i> <span data-i18n="aws.label.configname"></span></label>
        <input class="input-append-left" type="text" id="node-config-input-configname" style="width: 40%;" >
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-config-input-useIamRole" style="width: auto; margin-right: 8px;">
        <label for="node-config-input-useIamRole" style="display: inline; font-weight: 500;">
            Use IAM Role for authentication
        </label>
    </div>
    <div class="form-row">
        <span style="color: #888; font-size: 0.90em;">Recommended for EC2/ECS/Lambda.</span><br/>
        <span style="color: #888; font-size: 0.90em;">When enabled, credentials fields are ignored and AWS SDK will use the instance IAM role.</span>
    </div>
    <div class="credentials-fields">
        <div class="form-row">
            <label for="node-config-input-accessKeyId-typed"><i class="fa fa-bookmark"></i> <span data-i18n="aws.label.keyid"></span></label>
            <input type="text" id="node-config-input-accessKeyId-typed" style="width: 70%;">
            <input type="hidden" id="node-config-input-accessKeyIdType">
        </div>
        <div class="form-row">
            <label for="node-config-input-secretAccessKey-typed"><i class="fa fa-bookmark"></i> <span data-i18n="aws.label.secret"></span></label>
            <input type="password" id="node-config-input-secretAccessKey-typed" style="width: 70%;">
            <input type="hidden" id="node-config-input-secretAccessKeyType">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-region-typed"><i class="fa fa-tag"></i> <span data-i18n="aws.label.region"></span></label>
        <input type="text" id="node-config-input-region-typed" style="width: 70%;">
        <input type="hidden" id="node-config-input-regionType">
    </div>
    <div class="form-row">
        <label for="node-config-input-endpoint-typed"><i class="fa fa-tag"></i> <span data-i18n="aws.label.endpoint"></span></label>
        <input type="text" id="node-config-input-endpoint-typed" style="width: 70%;">
        <input type="hidden" id="node-config-input-endpointType">
    </div>
    <div class="form-tips">
        <span data-i18n="[html]aws.tip.config1"></span>
        <span data-i18n="[html]aws.tip.config2"></span>
    </div>
    <div class="form-row">
        <label for="node-config-input-forcepathstyle"><i class="fa fa-tag"></i> <span data-i18n="aws.label.forcepathstyle"></span></label>
        <input class="input-append-left" type="checkbox" id="node-config-input-forcepathstyle">
    </div>
    <div class="form-row">
        <label for="node-config-input-skiptlsverify"><i class="fa fa-tag"></i> <span data-i18n="aws.label.skiptlsverify"></span></label>
        <input class="input-append-left" type="checkbox" id="node-config-input-skiptlsverify">
    </div>
    <div class="form-tips">
        <span data-i18n="[html]aws.tip.config3"></span>
        <span data-i18n="[html]aws.tip.config4"></span>
    </div>
</script>
<script type="text/javascript">
    (function() {
        RED.nodes.registerType('aws-s3-config',{
            category: 'config',
            defaults: {
                configname: {value:"", required:true},
                endpoint: {value:""},
                endpointType: {value:"str"},
                forcepathstyle: {value:false},
                skiptlsverify: {value:false},
                useIamRole: {value:false},
                accessKeyId: {value:""},
                accessKeyIdType: {value:"str"},
                secretAccessKey: {value:""},
                secretAccessKeyType: {value:"str"},
                region: {value:"eu-west-1"},
                regionType: {value:"str"}
            },
            credentials: {
                accesskeyid: {type:"text"},
                secretaccesskey: {type:"password"}
            },
            label: function() {
                return this.configname;
            },
            oneditprepare: function() {
                var stdTypes = ['str', 'flow', 'global', 'env', 'msg'];
                $("#node-config-input-accessKeyId-typed").typedInput({
                    default: 'str',
                    types: stdTypes,
                    typeField: "#node-config-input-accessKeyIdType"
                });
                $("#node-config-input-accessKeyId-typed").typedInput('type', this.accessKeyIdType || 'str');
                $("#node-config-input-accessKeyId-typed").typedInput('value', this.accessKeyId || '');
                $("#node-config-input-secretAccessKey-typed").typedInput({
                    default: 'str',
                    types: stdTypes,
                    typeField: "#node-config-input-secretAccessKeyType"
                });
                $("#node-config-input-secretAccessKey-typed").typedInput('type', this.secretAccessKeyType || 'str');
                $("#node-config-input-secretAccessKey-typed").typedInput('value', this.secretAccessKey || '');
                $("#node-config-input-region-typed").typedInput({
                    default: 'str',
                    types: stdTypes,
                    typeField: "#node-config-input-regionType"
                });
                $("#node-config-input-region-typed").typedInput('type', this.regionType || 'str');
                $("#node-config-input-region-typed").typedInput('value', this.region || '');
                $("#node-config-input-endpoint-typed").typedInput({
                    default: 'str',
                    types: stdTypes,
                    typeField: "#node-config-input-endpointType"
                });
                $("#node-config-input-endpoint-typed").typedInput('type', this.endpointType || 'str');
                $("#node-config-input-endpoint-typed").typedInput('value', this.endpoint || '');
                $("#node-config-input-useIamRole").on("change", function() {
                    if ($(this).is(":checked")) {
                        $(".credentials-fields").hide();
                    } else {
                        $(".credentials-fields").show();
                    }
                });
                if ($("#node-config-input-useIamRole").is(":checked")) {
                    $(".credentials-fields").hide();
                }
            },
            oneditsave: function() {
                this.accessKeyId = $("#node-config-input-accessKeyId-typed").typedInput('value');
                this.accessKeyIdType = $("#node-config-input-accessKeyId-typed").typedInput('type');
                this.secretAccessKey = $("#node-config-input-secretAccessKey-typed").typedInput('value');
                this.secretAccessKeyType = $("#node-config-input-secretAccessKey-typed").typedInput('type');
                this.region = $("#node-config-input-region-typed").typedInput('value');
                this.regionType = $("#node-config-input-region-typed").typedInput('type');
                this.endpoint = $("#node-config-input-endpoint-typed").typedInput('value');
                this.endpointType = $("#node-config-input-endpoint-typed").typedInput('type');
            }
        });
    })();
</script>
<script type="text/x-red" data-template-name="aws-s3">
    <div class="form-row">
        <label for="node-input-aws"><i class="fa fa-user"></i> <span data-i18n="aws.label.aws"></span></label>
        <input type="text" id="node-input-aws">
    </div>
    <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-wrench"></i> Operation</label>
        <select type="text" id="node-input-operation" style="width: 100%;">
            <option value="AbortMultipartUpload">AbortMultipartUpload</option>
            <option value="CompleteMultipartUpload">CompleteMultipartUpload</option>
            <option value="CopyObject">CopyObject</option>
            <option value="CreateBucket">CreateBucket</option>
            <option value="CreateMultipartUpload">CreateMultipartUpload</option>
            <option value="DeleteBucket">DeleteBucket</option>
            <option value="DeleteBucketAnalyticsConfiguration">DeleteBucketAnalyticsConfiguration</option>
            <option value="DeleteBucketCors">DeleteBucketCors</option>
            <option value="DeleteBucketEncryption">DeleteBucketEncryption</option>
            <option value="DeleteBucketIntelligentTieringConfiguration">DeleteBucketIntelligentTieringConfiguration</option>
            <option value="DeleteBucketInventoryConfiguration">DeleteBucketInventoryConfiguration</option>
            <option value="DeleteBucketLifecycle">DeleteBucketLifecycle</option>
            <option value="DeleteBucketMetricsConfiguration">DeleteBucketMetricsConfiguration</option>
            <option value="DeleteBucketOwnershipControls">DeleteBucketOwnershipControls</option>
            <option value="DeleteBucketPolicy">DeleteBucketPolicy</option>
            <option value="DeleteBucketReplication">DeleteBucketReplication</option>
            <option value="DeleteBucketTagging">DeleteBucketTagging</option>
            <option value="DeleteBucketWebsite">DeleteBucketWebsite</option>
            <option value="DeleteObject">DeleteObject</option>
            <option value="DeleteObjectTagging">DeleteObjectTagging</option>
            <option value="DeleteObjects">DeleteObjects</option>
            <option value="DeletePublicAccessBlock">DeletePublicAccessBlock</option>
            <option value="GetBucketAccelerateConfiguration">GetBucketAccelerateConfiguration</option>
            <option value="GetBucketAcl">GetBucketAcl</option>
            <option value="GetBucketAnalyticsConfiguration">GetBucketAnalyticsConfiguration</option>
            <option value="GetBucketCors">GetBucketCors</option>
            <option value="GetBucketEncryption">GetBucketEncryption</option>
            <option value="GetBucketIntelligentTieringConfiguration">GetBucketIntelligentTieringConfiguration</option>
            <option value="GetBucketInventoryConfiguration">GetBucketInventoryConfiguration</option>
            <option value="GetBucketLifecycle">GetBucketLifecycle</option>
            <option value="GetBucketLifecycleConfiguration">GetBucketLifecycleConfiguration</option>
            <option value="GetBucketLocation">GetBucketLocation</option>
            <option value="GetBucketLogging">GetBucketLogging</option>
            <option value="GetBucketMetricsConfiguration">GetBucketMetricsConfiguration</option>
            <option value="GetBucketNotification">GetBucketNotification</option>
            <option value="GetBucketNotificationConfiguration">GetBucketNotificationConfiguration</option>
            <option value="GetBucketOwnershipControls">GetBucketOwnershipControls</option>
            <option value="GetBucketPolicy">GetBucketPolicy</option>
            <option value="GetBucketPolicyStatus">GetBucketPolicyStatus</option>
            <option value="GetBucketReplication">GetBucketReplication</option>
            <option value="GetBucketRequestPayment">GetBucketRequestPayment</option>
            <option value="GetBucketTagging">GetBucketTagging</option>
            <option value="GetBucketVersioning">GetBucketVersioning</option>
            <option value="GetBucketWebsite">GetBucketWebsite</option>
            <option value="GetObject">GetObject</option>
            <option value="GetObjectAcl">GetObjectAcl</option>
            <option value="GetObjectLegalHold">GetObjectLegalHold</option>
            <option value="GetObjectLockConfiguration">GetObjectLockConfiguration</option>
            <option value="GetObjectRetention">GetObjectRetention</option>
            <option value="GetObjectTagging">GetObjectTagging</option>
            <option value="GetObjectTorrent">GetObjectTorrent</option>
            <option value="GetPublicAccessBlock">GetPublicAccessBlock</option>
            <option value="HeadBucket">HeadBucket</option>
            <option value="HeadObject">HeadObject</option>
            <option value="ListBucketAnalyticsConfigurations">ListBucketAnalyticsConfigurations</option>
            <option value="ListBucketIntelligentTieringConfigurations">ListBucketIntelligentTieringConfigurations</option>
            <option value="ListBucketInventoryConfigurations">ListBucketInventoryConfigurations</option>
            <option value="ListBucketMetricsConfigurations">ListBucketMetricsConfigurations</option>
            <option value="ListBuckets">ListBuckets</option>
            <option value="ListMultipartUploads">ListMultipartUploads</option>
            <option value="ListObjectVersions">ListObjectVersions</option>
            <option value="ListObjects">ListObjects</option>
            <option value="ListObjectsV2">ListObjectsV2</option>
            <option value="ListParts">ListParts</option>
            <option value="PutBucketAccelerateConfiguration">PutBucketAccelerateConfiguration</option>
            <option value="PutBucketAcl">PutBucketAcl</option>
            <option value="PutBucketAnalyticsConfiguration">PutBucketAnalyticsConfiguration</option>
            <option value="PutBucketCors">PutBucketCors</option>
            <option value="PutBucketEncryption">PutBucketEncryption</option>
            <option value="PutBucketIntelligentTieringConfiguration">PutBucketIntelligentTieringConfiguration</option>
            <option value="PutBucketInventoryConfiguration">PutBucketInventoryConfiguration</option>
            <option value="PutBucketLifecycle">PutBucketLifecycle</option>
            <option value="PutBucketLifecycleConfiguration">PutBucketLifecycleConfiguration</option>
            <option value="PutBucketLogging">PutBucketLogging</option>
            <option value="PutBucketMetricsConfiguration">PutBucketMetricsConfiguration</option>
            <option value="PutBucketNotification">PutBucketNotification</option>
            <option value="PutBucketNotificationConfiguration">PutBucketNotificationConfiguration</option>
            <option value="PutBucketOwnershipControls">PutBucketOwnershipControls</option>
            <option value="PutBucketPolicy">PutBucketPolicy</option>
            <option value="PutBucketReplication">PutBucketReplication</option>
            <option value="PutBucketRequestPayment">PutBucketRequestPayment</option>
            <option value="PutBucketTagging">PutBucketTagging</option>
            <option value="PutBucketVersioning">PutBucketVersioning</option>
            <option value="PutBucketWebsite">PutBucketWebsite</option>
            <option value="PutObject">PutObject</option>
            <option value="PutObjectAcl">PutObjectAcl</option>
            <option value="PutObjectLegalHold">PutObjectLegalHold</option>
            <option value="PutObjectLockConfiguration">PutObjectLockConfiguration</option>
            <option value="PutObjectRetention">PutObjectRetention</option>
            <option value="PutObjectTagging">PutObjectTagging</option>
            <option value="PutPublicAccessBlock">PutPublicAccessBlock</option>
            <option value="RestoreObject">RestoreObject</option>
            <option value="SelectObjectContent">SelectObjectContent</option>
            <option value="UploadPart">UploadPart</option>
            <option value="UploadPartCopy">UploadPartCopy</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="aws.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]aws.placeholder.name">
    </div>
    <div class="form-row">
        <span style="color: #888; font-size: 0.90em;">
            <b>Note:</b> Operation parameters should be provided in the message object (msg). 
            For example: msg.Bucket, msg.Key, msg.Body, etc. 
            Complex objects can be provided as JSON strings and will be automatically parsed.
        </span>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('aws-s3', {
        category: 'storage-output',
        color: "#ffd0a1",
        defaults: {
            aws: { type: "aws-s3-config", required: true },
            operation: { value: "ListBuckets" },
            name: { value: "" },
            params: { value: {} }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["success", "error"],
        icon: "amazon.png",
        align: "right",
        label: function() {
            return this.name || "S3 API " + this.operation;
        },
        oneditprepare: function() {
            $("#node-input-operation").val(this.operation || 'ListBuckets');
        },
        oneditsave: function() {
            this.operation = $("#node-input-operation").val();
        }
    });
</script>

<script type="text/x-red" data-help-name="aws-s3">
    <p>
        Generic AWS S3 API node that supports all S3 operations using AWS SDK v3.
    </p>
    <p>
        <b>Usage:</b>
    </p>
    <ul>
        <li>Select the S3 operation from the dropdown</li>
        <li>Provide operation parameters in the message object (msg)</li>
        <li>Common parameters: msg.Bucket, msg.Key, msg.Body, etc.</li>
        <li>Complex objects can be provided as JSON strings</li>
        <li>For PutObject, you can use msg.payload as the body content</li>
    </ul>
    <p>
        <b>Examples:</b>
    </p>
    <ul>
        <li><b>ListBuckets:</b> No parameters needed</li>
        <li><b>ListObjects:</b> msg.Bucket = "my-bucket"</li>
        <li><b>GetObject:</b> msg.Bucket = "my-bucket", msg.Key = "path/to/file.txt"</li>
        <li><b>PutObject:</b> msg.Bucket = "my-bucket", msg.Key = "path/to/file.txt", msg.payload = "content"</li>
        <li><b>DeleteObject:</b> msg.Bucket = "my-bucket", msg.Key = "path/to/file.txt"</li>
    </ul>
    <p>
        The node uses connection pooling for optimal performance and automatically handles 
        response streaming for GetObject operations.
    </p>
</script>

<script type="text/javascript">
    var stdTypes = ['str', 'flow', 'global', 'env', 'msg'];
    function prepareTypedInput(selector, typeSelector, value, type) {
        $(selector).typedInput({
            default: 'str',
            types: stdTypes,
            typeField: typeSelector
        });
        $(selector).typedInput('type', type || 'str');
        $(selector).typedInput('value', value || '');
    }
</script>